---
import { formatDate } from "@lib/formatDate";
import readingTime from "@lib/readingTime";
import {
  lowerHumanize,
  upperHumanize,
  markdownify,
  slugify,
} from "@lib/textConverter";

import { Image } from "astro:assets";
import {
  FaRegCalendarAlt,
  FaRegFolder,
  FaRegUserCircle,
  FaHashtag,
  FaRegClock,
  FaRegEye,
} from "react-icons/fa";
import type { GenericEntry, EntryReference, ImageData } from "@/types";
import LiquidGlassLess from "./LiquidGlassLess.astro";
import Notice from "./shortcodes/Notice";
import ServerViewCount from "@components/blog/ServerViewCount.astro";

interface EntryData {
  title: string;
  image?: string;
  imageAlt?: string;
  author?: EntryReference;
  date?: string;
  pubDate?: string;
  modDate?: string;
  categories?: string[];
  tags?: string[];
  complexity?: number;
}

interface Props {
  entry: GenericEntry;
  showInfo?: boolean;
  showImage?: boolean;
  showTitle?: boolean;
  showAuthor?: boolean;
  showDate?: boolean;
  showPubDate?: boolean;
  showModDate?: boolean;
  showReadingTime?: boolean;
  showCategories?: boolean;
  showTags?: boolean;
  showViewCount?: boolean;
}

const {
  entry,
  showInfo = true,
  showImage = true,
  showAuthor = false,
  showDate = true,
  showPubDate = false,
  showModDate = false,
  showReadingTime = false,
  showCategories = false,
  showTags = false,
  showViewCount = false,
}: Props = Astro.props;

const {
  title,
  author,
  categories,
  tags,
  image,
  imageAlt,
  date,
  pubDate,
  modDate,
  complexity,
} = entry.data as EntryData;

categories?.sort((a: string, b: string) => a.localeCompare(b));
tags?.sort((a: string, b: string) => a.localeCompare(b));
---

<div class="">
  {
    showInfo && (
      <LiquidGlassLess
        heavy
        wrapperClass={`${image && showImage ? "dock mb-4 !p-0 overflow-hidden" : "dock mb-4 overflow-hidden"}`}
        textClass={`${image && showImage ? "" : "border border-white/10 dark:border-white/5"}`}
      >
        {}
        {image && showImage && (
          <div class="absolute inset-0">
            {typeof image === "string" ? (
              <img
                class="w-full h-full object-cover rounded-lg"
                src={image}
                alt={imageAlt || ""}
                height={280}
                width={1200}
                loading="eager"
              />
            ) : (
              <Image
                class="w-full h-full object-cover rounded-lg"
                src={image}
                alt={imageAlt || ""}
                height={280}
                width={1200}
                loading="eager"
              />
            )}
            {}
            <div class="absolute inset-0 bg-gradient-to-t from-black/50 via-black/10 to-black/0" />
          </div>
        )}

        {}
        <div
          class={`relative z-10 ${
            image && showImage
              ? "p-6 min-h-[280px] flex flex-col justify-end"
              : "p-4"
          }`}
        >
          <div class={`${image && showImage ? "text-white" : ""}`}>
            <h1
              set:html={markdownify(title)}
              class={`${
                image && showImage
                  ? "mb-4 text-white drop-shadow-lg text-shadow-lg text-lg sm:text-xl md:text-2xl lg:text-3xl font-bold"
                  : "mb-3 text-xl sm:text-2xl md:text-3xl font-bold text-gray-900 dark:text-white"
              }`}
            />
            <ul
              class={`flex flex-wrap gap-x-4 gap-y-2 text-xs sm:text-sm ${
                image && showImage
                  ? "text-white/90"
                  : "text-gray-600 dark:text-gray-300"
              }`}
            >
              {author && showAuthor && (
                <li class="flex items-center gap-1">
                  <a
                    href={`/authors/${slugify(author.id)}`}
                    class="flex items-center gap-1 hover:text-primary transition-colors"
                  >
                    <FaRegUserCircle className="text-base" />
                    <span>{upperHumanize(author.id)}</span>
                  </a>
                </li>
              )}
              {date && showDate && (
                <li class="flex items-center gap-1" title="创建日期">
                  <FaRegCalendarAlt className="text-base" />
                  <span>{formatDate(date)}</span>
                </li>
              )}
              {pubDate && showPubDate && (
                <li class="flex items-center gap-1" title="发布日期">
                  <FaRegCalendarAlt className="text-base" />
                  <span>Published {formatDate(pubDate)}</span>
                </li>
              )}
              {modDate && showModDate && (
                <li class="flex items-center gap-1">
                  <FaRegCalendarAlt className="text-base" />
                  <span>Updated {formatDate(modDate)}</span>
                </li>
              )}
              {complexity && complexity > 0 && showReadingTime && (
                <li class="flex items-center gap-1" title="阅读所需时间">
                  <FaRegClock className="text-base" />
                  <span>{readingTime(entry.body!, complexity)}</span>
                </li>
              )}
              {categories && showCategories && (
                <li class="flex flex-wrap items-center gap-1.5" title="分类">
                  {categories.map((category: string, index: number) => (
                    <a
                      href={`/blog/categories/${slugify(category)}`}
                      class="inline-flex items-center px-2.5 py-1 rounded-lg text-[11px] sm:text-xs font-medium min-h-[28px]
                             bg-zinc-200/80 dark:bg-zinc-700/60
                             text-zinc-700 dark:text-zinc-300
                             hover:bg-zinc-300 dark:hover:bg-zinc-600
                             active:scale-95
                             transition-all duration-200"
                    >
                      {upperHumanize(category)}
                    </a>
                  ))}
                </li>
              )}
              {tags && showTags && (
                <li class="flex flex-wrap items-center gap-1.5" title="标签">
                  {tags.map((tag: string, index: number) => (
                    <a
                      href={`/blog/tags/${slugify(tag)}`}
                      class="inline-flex items-center px-2.5 py-1 rounded-lg text-[11px] sm:text-xs font-medium min-h-[28px]
                             bg-zinc-100 dark:bg-zinc-800/60
                             text-zinc-600 dark:text-zinc-400
                             hover:bg-zinc-200 dark:hover:bg-zinc-700
                             active:scale-95
                             transition-all duration-200"
                    >
                      <span class="mr-0.5 opacity-60">#</span>
                      {lowerHumanize(tag)}
                    </a>
                  ))}
                </li>
              )}
              {showViewCount && (
                <li class="flex items-center gap-1" title="浏览次数">
                  <ServerViewCount slug={entry.id} />
                </li>
              )}
            </ul>
          </div>
        </div>
      </LiquidGlassLess>
    )
  }
</div>
