---

import { MUSIC_PLAYER_CONFIG } from "@lib/config";

interface Props {
  playlistId?: string;
  theme?: string;
  mode?: "loop" | "shuffle";
  autoplay?: boolean;
}

const {
  playlistId = MUSIC_PLAYER_CONFIG.PLAYLIST_ID,
  theme = MUSIC_PLAYER_CONFIG.THEME_COLOR,
  mode = MUSIC_PLAYER_CONFIG.ORDER === 'random' ? 'shuffle' : 'loop',
  autoplay = MUSIC_PLAYER_CONFIG.AUTOPLAY,
} = Astro.props;
---

<div id="music-player-fab" class="music-fab">
  
  <div class="fab-button" id="fab-button">
    <img id="fab-cover" src="/favicon/logo.png" alt="音乐" />
    <div class="fab-wave">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>

  
  <div class="fab-panel" id="fab-panel">
    
    <div class="panel-header">
      <div class="header-title">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 18V5l12-2v13"></path>
          <circle cx="6" cy="18" r="3"></circle>
          <circle cx="18" cy="16" r="3"></circle>
        </svg>
        <span>播放列表</span>
      </div>
      <button class="close-panel-btn" id="close-panel-btn" aria-label="收起">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    
    <div class="now-playing">
      <img id="panel-cover" src="" alt="封面" />
      <div class="now-playing-info">
        <div class="now-title" id="panel-title">加载中...</div>
        <div class="now-artist" id="panel-artist">-</div>
      </div>
    </div>

    
    <div class="player-controls">
      <audio id="plyr-audio" controls>
        <source src="" type="audio/mp3" />
      </audio>
    </div>

    
    <div class="playlist-list" id="playlist-list">
      
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css" />
<script is:inline src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.min.js"></script>

<script define:vars={{ playlistId, theme, mode, autoplay }}>
  const MUSIC_STATE_KEY = 'music_player_state';

  const state = {
    playlist: [],
    currentIndex: 0,
    player: null,
    isExpanded: false,
  };

  // Save current playing state to localStorage for cross-page sync
  function savePlayingState() {
    if (state.playlist.length === 0) return;
    const song = state.playlist[state.currentIndex];
    const audio = document.getElementById("plyr-audio");
    const playState = {
      index: state.currentIndex,
      songId: song?.id || state.currentIndex,
      title: song?.title,
      artist: song?.artist,
      currentTime: audio?.currentTime || 0,
      isPlaying: state.player?.playing || false,
      timestamp: Date.now()
    };
    localStorage.setItem(MUSIC_STATE_KEY, JSON.stringify(playState));
  }

  // Restore playing state from localStorage
  function restorePlayingState() {
    try {
      const saved = localStorage.getItem(MUSIC_STATE_KEY);
      if (!saved) return null;
      const playState = JSON.parse(saved);
      // Only restore if saved within last 24 hours
      if (Date.now() - playState.timestamp > 86400000) return null;
      return playState;
    } catch {
      return null;
    }
  }

  
  async function initPlayer() {
    if (typeof Plyr === "undefined") {
      setTimeout(initPlayer, 100);
      return;
    }

    try {
      
      const cacheKey = `music_playlist_${playlistId}`;
      const cached = localStorage.getItem(cacheKey);
      const cacheTime = localStorage.getItem(`${cacheKey}_time`);
      const now = Date.now();

      let data;

      if (cached && cacheTime && (now - parseInt(cacheTime)) < 3600000) {
        
        data = JSON.parse(cached);
      } else {
        
        const response = await fetch(
          `https://api.i-meto.com/meting/api?server=netease&type=playlist&id=${playlistId}`
        );
        data = await response.json();

        
        localStorage.setItem(cacheKey, JSON.stringify(data));
        localStorage.setItem(`${cacheKey}_time`, now.toString());
      }

      if (!data || data.length === 0) return;

      state.playlist = data.map((item) => ({
        title: item.name || item.title || "未知歌曲",
        artist: Array.isArray(item.artist)
          ? item.artist.join("/")
          : item.artist || item.author || "未知歌手",
        url: item.url,
        cover: item.pic || item.cover || "/favicon/logo.png",
      }));

      
      const audio = document.getElementById("plyr-audio");
      state.player = new Plyr(audio, {
        controls: ["play", "progress", "current-time", "mute", "volume"],
        autoplay: autoplay,
        volume: 0.7,
      });

      // Restore saved state or start from beginning
      const savedState = restorePlayingState();
      if (savedState && savedState.index < state.playlist.length) {
        loadSong(savedState.index);
        // Restore playback position after a small delay
        setTimeout(() => {
          const audio = document.getElementById("plyr-audio");
          if (audio && savedState.currentTime > 0) {
            audio.currentTime = savedState.currentTime;
          }
        }, 100);
      } else {
        loadSong(0);
      }

      renderPlaylist();
      bindEvents();
    } catch (error) {

    }
  }

  
  function loadSong(index) {
    if (index < 0 || index >= state.playlist.length) return;

    const song = state.playlist[index];
    state.currentIndex = index;

    const audio = document.getElementById("plyr-audio");
    audio.src = song.url;

    
    const coverUrl = song.cover || "/favicon/logo.png";
    document.getElementById("fab-cover").src = coverUrl;
    document.getElementById("panel-cover").src = coverUrl;
    document.getElementById("panel-title").textContent = song.title || "未知歌曲";
    document.getElementById("panel-artist").textContent = song.artist || "未知歌手";

    updatePlaylistHighlight();
  }

  
  function playNext() {
    let nextIndex;
    if (mode === "shuffle") {
      nextIndex = Math.floor(Math.random() * state.playlist.length);
    } else {
      nextIndex = (state.currentIndex + 1) % state.playlist.length;
    }
    loadSong(nextIndex);
    state.player.play();
  }

  
  function renderPlaylist() {
    const container = document.getElementById("playlist-list");
    container.innerHTML = state.playlist
      .map(
        (song, index) => `
        <div class="playlist-item-compact" data-index="${index}">
          <img src="${song.cover}" alt="" />
          <div class="item-info-compact">
            <div class="item-name">${song.title}</div>
            <div class="item-singer">${song.artist}</div>
          </div>
          <div class="item-playing-icon">♪</div>
        </div>
      `
      )
      .join("");

    container.querySelectorAll(".playlist-item-compact").forEach((item) => {
      item.addEventListener("click", () => {
        const index = parseInt(item.dataset.index);
        loadSong(index);
        state.player.play();
      });
    });
  }

  
  function updatePlaylistHighlight() {
    document.querySelectorAll(".playlist-item-compact").forEach((item, index) => {
      item.classList.toggle("active", index === state.currentIndex);
    });
  }

  
  function bindEvents() {
    // Track playback events for state sync
    state.player.on("ended", playNext);
    state.player.on("play", savePlayingState);
    state.player.on("pause", savePlayingState);

    // Save state periodically during playback
    const audio = document.getElementById("plyr-audio");
    audio.addEventListener("timeupdate", () => {
      // Save every 5 seconds
      if (Math.floor(audio.currentTime) % 5 === 0) {
        savePlayingState();
      }
    });

    const fab = document.getElementById("music-player-fab");
    const fabButton = document.getElementById("fab-button");
    const closeBtn = document.getElementById("close-panel-btn");

    fabButton.addEventListener("click", (e) => {
      e.stopPropagation();
      state.isExpanded = true;
      fab.classList.add("expanded");
    });

    closeBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      state.isExpanded = false;
      fab.classList.remove("expanded");
    });

    document.addEventListener("click", (e) => {
      if (state.isExpanded && !fab.contains(e.target)) {
        state.isExpanded = false;
        fab.classList.remove("expanded");
      }
    }, true);
  }

  
  if (!window.musicPlayerInitialized) {
    window.musicPlayerInitialized = true;

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initPlayer);
    } else {
      initPlayer();
    }

    
    document.addEventListener("astro:before-preparation", () => {
      if (state.player) {
        try {
          state.player.destroy();
        } catch (e) {}
        state.player = null;
      }
    });
  }
</script>

<style is:global>
  
  .music-fab {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 9999;
  }

  
  .fab-button {
    position: relative;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: v-bind(theme);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    cursor: pointer;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .fab-button:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.3);
  }

  .fab-button:active {
    transform: scale(0.95);
  }

  .fab-button img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  
  .fab-wave {
    position: absolute;
    bottom: 6px;
    right: 6px;
    display: flex;
    gap: 2px;
    align-items: flex-end;
    height: 16px;
    background: rgba(0, 0, 0, 0.5);
    padding: 3px 4px;
    border-radius: 4px;
  }

  .fab-wave span {
    width: 2px;
    background: white;
    border-radius: 2px;
    animation: wave 0.8s ease-in-out infinite;
  }

  .fab-wave span:nth-child(1) { animation-delay: 0s; }
  .fab-wave span:nth-child(2) { animation-delay: 0.2s; }
  .fab-wave span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes wave {
    0%, 100% { height: 4px; }
    50% { height: 14px; }
  }

  
  .fab-panel {
    position: absolute;
    bottom: 72px;
    right: 0;
    width: 360px;
    max-height: 520px;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px) scale(0.9);
    transform-origin: bottom right;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .music-fab.expanded .fab-panel {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
  }

  
  .music-fab.expanded .fab-button {
    opacity: 0.3;
    pointer-events: none;
  }

  
  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background: linear-gradient(135deg, v-bind(theme) 0%, rgba(v-bind(theme), 0.8) 100%);
    color: white;
    border-radius: 16px 16px 0 0;
  }

  .header-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 15px;
    font-weight: 600;
  }

  .close-panel-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .close-panel-btn:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  
  .now-playing {
    display: flex;
    gap: 12px;
    padding: 16px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .now-playing img {
    width: 56px;
    height: 56px;
    border-radius: 8px;
    object-fit: cover;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .now-playing-info {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .now-title {
    font-size: 15px;
    font-weight: 600;
    color: #1a1a1a;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 4px;
  }

  .now-artist {
    font-size: 13px;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  
  .player-controls {
    padding: 12px 16px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .player-controls audio {
    display: none;
  }

  
  .plyr {
    --plyr-color-main: v-bind(theme);
  }

  .plyr__controls {
    background: transparent;
    padding: 0;
  }

  .plyr--audio .plyr__controls {
    background: transparent;
    color: #1a1a1a;
  }

  
  .playlist-list {
    max-height: 320px;
    overflow-y: auto;
    padding: 8px;
  }

  .playlist-item-compact {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .playlist-item-compact:hover {
    background: rgba(0, 0, 0, 0.04);
  }

  .playlist-item-compact.active {
    background: rgba(v-bind(theme), 0.1);
  }

  .playlist-item-compact img {
    width: 44px;
    height: 44px;
    border-radius: 6px;
    object-fit: cover;
    flex-shrink: 0;
  }

  .item-info-compact {
    flex: 1;
    min-width: 0;
  }

  .item-name {
    font-size: 14px;
    font-weight: 500;
    color: #1a1a1a;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 2px;
  }

  .item-singer {
    font-size: 12px;
    color: #999;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .item-playing-icon {
    color: v-bind(theme);
    font-size: 16px;
    opacity: 0;
    transition: opacity 0.2s;
    flex-shrink: 0;
  }

  .playlist-item-compact.active .item-playing-icon {
    opacity: 1;
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
  }

  
  :global(.dark) .fab-panel {
    background: rgba(30, 30, 30, 0.98);
  }

  :global(.dark) .now-playing {
    border-bottom-color: rgba(255, 255, 255, 0.1);
  }

  :global(.dark) .player-controls {
    border-bottom-color: rgba(255, 255, 255, 0.1);
  }

  :global(.dark) .now-title,
  :global(.dark) .item-name {
    color: #e0e0e0;
  }

  :global(.dark) .now-artist,
  :global(.dark) .item-singer {
    color: #a0a0a0;
  }

  :global(.dark) .playlist-item-compact:hover {
    background: rgba(255, 255, 255, 0.06);
  }

  :global(.dark) .plyr--audio .plyr__controls {
    color: #e0e0e0;
  }

  
  .playlist-list::-webkit-scrollbar {
    width: 6px;
  }

  .playlist-list::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 3px;
  }

  .playlist-list::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
  }

  :global(.dark) .playlist-list::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
  }

  :global(.dark) .playlist-list::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
  }

  
  @media (max-width: 768px) {
    .music-fab {
      bottom: 16px;
      right: 16px;
    }

    .fab-panel {
      width: calc(100vw - 32px);
      max-width: 360px;
      right: -8px;
    }

    .fab-button {
      width: 48px;
      height: 48px;
    }
  }
</style>
