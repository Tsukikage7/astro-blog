---
// ç½‘æ˜“äº‘éŸ³ä¹æ’­æ”¾å™¨ç»„ä»¶
// ä½¿ç”¨ APlayer + MetingJS å®ç°
import { MUSIC_PLAYER_CONFIG } from "@lib/config";

interface Props {
  // ç½‘æ˜“äº‘æ­Œå• IDï¼Œä¾‹å¦‚: "2539599584"
  playlistId?: string;
  // æ˜¯å¦å›ºå®šåœ¨åº•éƒ¨
  fixed?: boolean;
  // æ˜¯å¦æ˜¾ç¤ºæ­Œè¯
  lrc?: boolean;
  // ä¸»é¢˜è‰²
  theme?: string;
  // æ’­æ”¾æ¨¡å¼: circulation(å¾ªç¯) | order(é¡ºåº) | random(éšæœº) | single(å•æ›²)
  order?: "circulation" | "order" | "random" | "single";
  // é¢„åŠ è½½æ¨¡å¼
  preload?: "none" | "metadata" | "auto";
  // æ˜¯å¦è‡ªåŠ¨æ’­æ”¾
  autoplay?: boolean;
}

const {
  playlistId = MUSIC_PLAYER_CONFIG.PLAYLIST_ID,
  fixed = MUSIC_PLAYER_CONFIG.FIXED,
  lrc = MUSIC_PLAYER_CONFIG.SHOW_LRC,
  theme = MUSIC_PLAYER_CONFIG.THEME_COLOR,
  order = MUSIC_PLAYER_CONFIG.ORDER,
  preload = MUSIC_PLAYER_CONFIG.PRELOAD,
  autoplay = MUSIC_PLAYER_CONFIG.AUTOPLAY,
} = Astro.props;
---

<!-- APlayer å®¹å™¨ -->
<div id="aplayer" class:list={[fixed && "aplayer-fixed"]}></div>

<!-- å¼•å…¥ APlayer å’Œ MetingJS çš„ CSS -->
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css"
/>

<!-- å¼•å…¥ APlayer å’Œ MetingJS çš„ JS -->
<script
  is:inline
  src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"
></script>
<script
  is:inline
  src="https://cdn.jsdelivr.net/npm/meting@2.0.1/dist/Meting.min.js"
></script>

<!-- åˆå§‹åŒ–æ’­æ”¾å™¨ -->
<script
  define:vars={{
    playlistId,
    fixed,
    lrc,
    theme,
    order,
    preload,
    autoplay,
  }}
>
  // ç¡®ä¿åœ¨ DOM å’Œ APlayer åŠ è½½å®Œæˆååˆå§‹åŒ–
  function initMusicPlayer() {
    // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡
    if (window.aplayer) {
      return;
    }

    // æ£€æŸ¥ APlayer æ˜¯å¦å·²åŠ è½½
    if (typeof APlayer === 'undefined') {
      console.log("ç­‰å¾… APlayer åŠ è½½...");
      setTimeout(initMusicPlayer, 100);
      return;
    }

    const container = document.getElementById("aplayer");
    if (!container) {
      console.warn("æœªæ‰¾åˆ°æ’­æ”¾å™¨å®¹å™¨");
      return;
    }

    console.log("å¼€å§‹åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨...");

    // ä½¿ç”¨ MetingJS API è·å–ç½‘æ˜“äº‘æ­Œå•
    fetch(
      `https://api.i-meto.com/meting/api?server=netease&type=playlist&id=${playlistId}`
    )
      .then((response) => response.json())
      .then((data) => {
        if (!data || data.length === 0) {
          console.warn("æœªèƒ½åŠ è½½æ­Œå•ï¼Œä½¿ç”¨é»˜è®¤é…ç½®");
          return;
        }

        console.log(`æˆåŠŸè·å–æ­Œå•,å…± ${data.length} é¦–æ­Œæ›²`);

        // åˆå§‹åŒ– APlayer
        window.aplayer = new APlayer({
          container: container,
          fixed: fixed,
          mini: fixed, // å›ºå®šæ¨¡å¼ä½¿ç”¨è¿·ä½ æ’­æ”¾å™¨
          autoplay: autoplay,
          theme: theme,
          loop: order === "circulation" ? "all" : order === "single" ? "one" : "none",
          order: order === "random" ? "random" : "list",
          preload: preload,
          volume: 0.7,
          mutex: true,
          lrcType: lrc ? 3 : 0,
          audio: data.map((item) => ({
            name: item.name,
            artist: item.artist.join("/"),
            url: item.url,
            cover: item.pic,
            lrc: item.lrc || "",
          })),
        });

        console.log("ğŸµ éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–æˆåŠŸ");
      })
      .catch((error) => {
        console.error("åŠ è½½éŸ³ä¹æ’­æ”¾å™¨å¤±è´¥:", error);
      });
  }

  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initMusicPlayer);
  } else {
    initMusicPlayer();
  }

  // Astro é¡µé¢åˆ‡æ¢åé‡æ–°åˆå§‹åŒ–
  document.addEventListener("astro:page-load", initMusicPlayer);

  // é¡µé¢å¸è½½æ—¶æ¸…ç†
  document.addEventListener("astro:before-preparation", () => {
    if (window.aplayer) {
      window.aplayer.destroy();
      window.aplayer = null;
    }
  });
</script>

<style is:global>
  /* å›ºå®šæ’­æ”¾å™¨æ ·å¼ä¼˜åŒ– */
  .aplayer-fixed {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    margin: 0;
    z-index: 99;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
  }

  /* æ·±è‰²æ¨¡å¼é€‚é… */
  :global(.dark) .aplayer {
    background: rgba(30, 30, 30, 0.95);
    backdrop-filter: blur(10px);
  }

  :global(.dark) .aplayer .aplayer-list {
    background: rgba(40, 40, 40, 0.95);
  }

  :global(.dark) .aplayer .aplayer-body,
  :global(.dark) .aplayer .aplayer-info {
    background: transparent;
  }

  :global(.dark) .aplayer .aplayer-info .aplayer-music .aplayer-title,
  :global(.dark) .aplayer .aplayer-info .aplayer-music .aplayer-author {
    color: #e0e0e0;
  }

  :global(.dark) .aplayer .aplayer-list li {
    color: #e0e0e0;
    border-top-color: rgba(255, 255, 255, 0.1);
  }

  :global(.dark) .aplayer .aplayer-list li:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  :global(.dark) .aplayer .aplayer-list li.aplayer-list-light {
    background: rgba(255, 255, 255, 0.1);
  }

  /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
  @media (max-width: 768px) {
    .aplayer-fixed {
      max-width: 100%;
    }

    .aplayer.aplayer-withlist .aplayer-list {
      max-height: 50vh;
    }
  }

  /* ç¡®ä¿æ’­æ”¾å™¨ä¸ä¼šé®æŒ¡é¡µé¢å†…å®¹ */
  body {
    padding-bottom: 66px; /* ä¸ºå›ºå®šæ’­æ”¾å™¨ç•™å‡ºç©ºé—´ */
  }

  /* è¿·ä½ æ¨¡å¼æ ·å¼ */
  .aplayer.aplayer-fixed.aplayer-narrow {
    width: 66px;
  }
</style>
