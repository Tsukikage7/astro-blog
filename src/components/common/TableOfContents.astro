---
import type { HeadingHierarchy } from "@/types/index";
import type { MarkdownHeading } from "astro";
import { createHeadingHierarchy } from "@lib/tocUtils";
import LiquidGlass from "./LiquidGlassLess.astro";

interface Props {
  headings: MarkdownHeading[];
  tocDepth?: number;
}

const { headings, tocDepth = 3 } = Astro.props;
const heirarchy: HeadingHierarchy[] = createHeadingHierarchy(headings);
const toc = heirarchy.filter((heading) => heading.depth <= tocDepth);
---

{
  toc.length > 0 && (
    <LiquidGlass heavy animation="fadeLeft" wrapperClass="dock !p-6" >
      <div class="intersect:animate-fadeLeft">
        <h2 class="text-2xl border-none mb-3">内容导航</h2>
        <div class="max-h-96 overflow-y-auto">
          <ul class="list-none m-0 space-y-1">
            {toc.map((heading) => (
              <li class=`${heading.depth === 2 ? "ml-0" : "ml-4"}`>
                <a href={`#${heading.slug}`} class="block w-full leading-relaxed no-underline hover:text-primary transition-colors duration-200 py-1" data-toc-link>
                  {heading.text}
                </a>
              </li>
            ))}
          </ul>
        </div>
      </div>
    </LiquidGlass>
  )
}

<style>
  
  :global(h1, h2, h3, h4, h5, h6) {
    scroll-margin-top: 8rem; 
  }
  
  
  [data-toc-link] {
    cursor: pointer;
    transition: color 0.2s ease;
  }
  
  [data-toc-link]:hover {
    color: var(--color-primary, #f97316);
  }
</style>

<script>
  
  function getHeaderHeight(): number {
    const header = document.querySelector('header');
    if (header) {
      const headerHeight = header.offsetHeight;
      console.log('Header height:', headerHeight); 
      return headerHeight + 32; 
    }
    return 140; 
  }

  
  function setupTocLinks() {
    const tocLinks = document.querySelectorAll('[data-toc-link]');
    
    tocLinks.forEach(link => {
      
      const newLink = link.cloneNode(true);
      link.parentNode?.replaceChild(newLink, link);
      
      newLink.addEventListener('click', function(e: Event) {
        e.preventDefault();
        const target = e.currentTarget as HTMLAnchorElement;
        const href = target.getAttribute('href');
        if (!href) return;
        
        const targetId = href.substring(1);
        const targetElement = document.getElementById(targetId);
        
        if (targetElement) {
          
          const rect = targetElement.getBoundingClientRect();
          const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
          const headerHeight = getHeaderHeight();
          
          
          const targetScrollTop = currentScrollTop + rect.top - headerHeight;
          
          
          console.log('Target element:', targetElement);
          console.log('Element rect.top:', rect.top);
          console.log('Current scroll top:', currentScrollTop);
          console.log('Header height:', headerHeight);
          console.log('Target scroll position:', targetScrollTop);
          
          window.scrollTo({
            top: Math.max(0, targetScrollTop),
            behavior: 'smooth'
          });
          
          
          history.pushState(null, "", `#${targetId}`);
        }
      });
    });
  }

  
  document.addEventListener('DOMContentLoaded', setupTocLinks);
  
  
  document.addEventListener('astro:page-load', setupTocLinks);
</script>
