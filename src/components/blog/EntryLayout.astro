---
import BaseLayout from "@components/base/BaseLayout.astro";
import { plainify } from "@lib/textConverter";
import { render, type CollectionEntry, getCollection } from "astro:content";
import TableOfContents from "@components/common/TableOfContents.astro";
import EntryHeader from "@components/common/EntryHeader.astro";
import "../../styles/markdown.scss";
import { SITE_INFO } from "@lib/config";
import LiquidGlassLess from "@components/common/LiquidGlassLess.astro";
import Comment from "@components/base/Comment.astro";

import ShareButton from "@components/blog/ShareButton.astro";
import RecommendedReadCard from "@components/blog/RecommendedReadCard.astro";
import type { BlogEntry } from "@/types";

interface Props {
  entry: CollectionEntry<"blog">;
}
const { entry } = Astro.props;
const { title, description, image, updated } = entry.data;

const { headings } = await render(entry);

const descriptionLenth = 200;
const globalHideToc = false;
const tocDepth = 3;

const actuallyHideToc =
  globalHideToc ||
  headings.filter((heading) => heading.depth <= tocDepth).length === 0;

const articleClass = "w-full lg:w-3/4 xl:w-4/5"; 

const tocClass = actuallyHideToc
  ? "hidden"
  : "hidden md:flex md:w-1/4 lg:w-1/5";

const entryDescription =
  description ||
  (entry.body ? plainify(entry.body.slice(0, descriptionLenth)) : "");

const allBlogPosts = (await getCollection("blog", ({ filePath }) => {
  if(filePath?.includes("-index.md")){
    return false;
  }
  return true;
})) as BlogEntry[];

const currentTags = entry.data.tags || [];
const currentCategories = entry.data.categories || [];

const recommendedPosts = allBlogPosts
  .filter((post) => post.id !== entry.id) 
  .map((post) => {
    let score = 0;
    const postTags = post.data.tags || [];
    const postCategories = post.data.categories || [];

    
    const tagMatches = postTags.filter((tag) =>
      currentTags.includes(tag),
    ).length;
    score += tagMatches * 2;

    
    const categoryMatches = postCategories.filter((cat) =>
      currentCategories.includes(cat),
    ).length;
    score += categoryMatches * 3;

    return { post, score };
  })
  .sort((a, b) => {

    if (b.score !== a.score) {
      return b.score - a.score;
    }
    const dateA = new Date(
      a.post.data.created || 0,
    );
    const dateB = new Date(
      b.post.data.created || 0,
    );
    return dateB.getTime() - dateA.getTime();
  })
  .slice(0, 5) 
  .map((item) => item.post);
---

<BaseLayout title={title} description={entryDescription} image={image?.src}>
  <section class="flex container px-3 lg:px-8">
    <div class:list={[articleClass]}>
      <article>
        <section>
          <EntryHeader
            entry={entry}
            showImage
            showAuthor
            showDate
            showReadingTime
            showCategories
            showTags
            showViewCount
          />
        </section>
        <LiquidGlassLess
          containerType="section"
          heavy
          wrapperClass="panel flex flex-col justify-between mb-4 rounded-[35px] intersect-no-queue min-h-96"
        >
          <div
            class="p-3 lg:p-8 prose max-w-none markdown-content text-txt-p dark:text-darkmode-txt-p intersect:animate-fadeUp"
          >
            <slot />
          </div>
        </LiquidGlassLess>
        
        
        <div class="relative mt-16">
          
          <div
            class="left_centor -top-12 transform -translate-x-1/2 z-10 animate-fadeUp"
          >
            <div class="relative group">
              <div
                class="absolute -inset-2 bg-gradient-to-r from-orange-500 via-indigo-500 to-green-500 rounded-[35px] blur opacity-40 group-hover:opacity-60 transition duration-300"
              >
              </div>
              <img
                class="relative w-20 h-20 rounded-full border-4 border-white/50 shadow-2xl transform group-hover:scale-105 transition-all duration-300 bg-white/10 backdrop-blur-sm"
                src={SITE_INFO.AUTHOR_AVATAR}
                alt="Author"
                width="80"
                height="80"
                loading="lazy"
              />
            </div>
          </div>

          <LiquidGlassLess
            heavy
            wrapperClass="dock rounded-2xl pt-16 pb-8 px-8"
            textClass="intersect-no-queue"
          >
            
            <div class="text-center m-6">
              <div
                class="font-bold text-2xl text-txt-p dark:text-darkmode-txt-p mb-1"
              >
                Tsukikage
              </div>

            </div>

            
            <div class="flex items-center justify-center gap-4 mb-2">
              <ShareButton
                title={title}
                description={entryDescription}
                folder="blog"
                id={entry.id}
              />
            </div>

            
            <div
              class="w-full h-px bg-gradient-to-r from-transparent via-white/20 to-transparent mb-2"
            >
            </div>

            
            <div class="space-y-4 text-center">
              
              <div
                class="text-xs text-txt-p dark:text-darkmode-txt-p opacity-75 leading-relaxed"
              >
                <div
                  class="flex flex-col sm:flex-row items-center justify-center gap-2 sm:gap-4"
                >
                  <span>
                    © 2025 by
                    <a href={SITE_INFO.URL}>{SITE_INFO.SITE_NAME}</a>
                     本文基于
                    <a
                      target="_blank"
                      href="https://creativecommons.org/licenses/by-nc-sa/4.0/"
                      class="font-bold"
                    >
                      CC BY-NC-SA 4.0
                    </a>
                     许可
                    <img
                      src="https://mirrors.creativecommons.org/presskit/icons/cc.svg"
                      alt="CC 协议"
                      aria-label="CC 协议"
                      style="max-width: 1em;max-height:1em; display:inline-block;"
                    />
                    <img
                      src="https://mirrors.creativecommons.org/presskit/icons/by.svg"
                      alt="必须注明创作者"
                      style="max-width: 1em;max-height:1em;display:inline-block;"
                    />
                    <img
                      src="https://mirrors.creativecommons.org/presskit/icons/nc.svg"
                      alt="仅允许将作品用于非商业用途"
                      style="max-width: 1em;max-height:1em;display:inline-block;"
                    />
                    <img
                      src="https://mirrors.creativecommons.org/presskit/icons/sa.svg"
                      alt="改编作品必须遵循相同条款进行共享"
                      style="max-width: 1em;max-height:1em;display:inline-block;"
                    />
                  </span>
                  <span class="hidden sm:inline text-white/30">|</span>
                  <span class="inline-flex items-center gap-2">
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                     最后更新：{
                      updated
                        ? new Date(updated).toLocaleDateString("zh-CN")
                        : "未知"
                    }
                  </span>
                </div>
              </div>
            </div>
          </LiquidGlassLess>
        </div>

        <LiquidGlassLess
          heavy
          wrapperClass="dock rounded-lg p-6 my-4"
          textClass="intersect-no-queue  px-3 lg:px-8 "
        >
          <Comment />
        </LiquidGlassLess>
      </article>
    </div>

    
    <div
      class="flex-col h-full sticky top-[4rem] ml-4 space-y-4 hidden lg:flex lg:w-1/4 xl:w-1/5"
    >
      <TableOfContents headings={headings} tocDepth={tocDepth} />

      
      {
        recommendedPosts.length > 0 && (
          <LiquidGlassLess
            heavy
            wrapperClass="dock rounded-[25px] overflow-hidden mb-3"
            textClass="intersect-no-queue"
          >
            <div class="py-2">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-txt-p dark:text-darkmode-txt-p flex items-center gap-2">
                  <svg
                    class="w-5 h-5 text-orange-500"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
                    />
                  </svg>
                  推荐阅读
                </h3>
              </div>

              <div class="space-y-1">
                {recommendedPosts.map((post, index) => (
                  <div
                    class="intersect:animate-fadeUp"
                    style={`animation-delay: ${index * 100}ms`}
                  >
                    <RecommendedReadCard
                      entry={post}
                      showImage={true}
                      showReadingTime={true}
                      compact={true}
                    />
                  </div>
                ))}
              </div>
            </div>
          </LiquidGlassLess>
        )
      }
    </div>
  </section>
</BaseLayout>
