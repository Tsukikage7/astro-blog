---
import ThemeSwitcher from "@components/base/ThemeSwitcher.astro";
import { IoSearch } from "react-icons/io5";
import { SITE_INFO } from "@lib/config";
import { Image } from "astro:assets";

const { pathname } = Astro.url;

const stickyHeader = true;

let siteName = SITE_INFO?.SITE_NAME || ""; 
let siteLogoUrl = SITE_INFO?.LOGO_IMAGE || "";

const menu = [
  {
    id: 1,
    name: "首页",
    url: "/",
    icon: "home",
  },
  {
    id: 2,
    name: "博客",
    url: "/blog",
    icon: "blog",
  },
  {
    id: 3,
    name: "文字",
    url: "/writings",
    icon: "pen",
  },
  {
    id: 4,
    name: "动态",
    url: "/notes",
    icon: "chat",
  },
  {
    id: 5,
    name: "音乐",
    url: "/music",
    icon: "music",
  },
  {
    id: 6,
    name: "关于",
    url: "/about",
    icon: "user",
  },
];

const icons: Record<string, string> = {
  home: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />`,
  blog: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />`,
  pen: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />`,
  chat: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />`,
  music: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />`,
  user: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />`,
};
---

<header
  transition:persist
  class={`w-full py-3 z-30 bg-background/80 backdrop-blur-sm border-b border-border/30 ${stickyHeader && "sticky top-0"}`}
>
  <div class="container px-4 lg:px-8 mx-auto">
    <nav class="flex items-center justify-between">

    <!-- Logo + Site Name -->
    <div class="flex-shrink-0">
      <a href="/" class="flex items-center gap-2">
        {
          siteLogoUrl && (
            <Image
              src={siteLogoUrl}
              alt={siteName}
              class="w-8 h-8 rounded-full"
              width={32}
              height={32}
              eagerly-loaded={true}
            />
          )
        }
        {
          siteName && (
            <span class="text-lg font-semibold text-foreground hidden sm:inline">
              {siteName}
            </span>
          )
        }
      </a>
    </div>

    <!-- Mobile menu toggle -->
    <input id="nav-toggle" type="checkbox" class="hidden" />
    <label
      for="nav-toggle"
      class="cursor-pointer flex items-center md:hidden text-txt-p dark:text-darkmode-txt-p"
    >
      <svg
        id="show-button"
        class="h-5 fill-current block"
        viewBox="0 0 20 20"
      >
        <title>Menu Open</title>
        <path d="M0 3h20v2H0V3z m0 6h20v2H0V9z m0 6h20v2H0V0z"></path>
      </svg>
      <svg
        id="hide-button"
        class="h-5 fill-current hidden"
        viewBox="0 0 20 20"
      >
        <title>Menu Close</title>
        <polygon
          points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2"
          transform="rotate(45 10 10)"></polygon>
      </svg>
    </label>

    <!-- Navigation - 居中平铺 -->
    <ul
      id="nav-menu"
      class="bg-background md:bg-transparent text-center absolute md:static top-full left-0 right-0 hidden w-full p-4 md:flex md:flex-1 md:justify-center md:items-center md:gap-8 lg:gap-12 md:p-0"
    >
      {
        menu.map((item: any) => {
          const isActive = pathname === `${item.url}/` || pathname === item.url ||
            (item.url !== "/" && pathname.startsWith(item.url));
          const iconPath = icons[item.icon] || "";
          return (
            <li>
              <a
                href={item.url}
                class={`nav-link group relative flex items-center gap-1.5 py-3 md:py-1 text-base font-medium tracking-wide transition-all duration-300 ${
                  isActive
                    ? "text-foreground"
                    : "text-muted-foreground hover:text-foreground"
                }`}
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" set:html={iconPath} />
                <span class="relative z-10">{item.name}</span>
                <span
                  class={`absolute bottom-0 left-1/2 -translate-x-1/2 h-[2px] bg-foreground/80 transition-all duration-300 ease-out ${
                    isActive ? "w-5" : "w-0 group-hover:w-5"
                  }`}
                />
              </a>
            </li>
          );
        })
      }
    </ul>

    <!-- Right icons -->
    <div class="flex-shrink-0 flex items-center gap-2">
      <a
        class="p-2 text-muted-foreground hover:text-foreground transition-all duration-300 hover:scale-110"
        href="/search"
        aria-label="search"
        title="搜索"
      >
        <IoSearch className="w-[18px] h-[18px]" />
      </a>

      <button
        id="random-article-btn"
        class="p-2 text-muted-foreground hover:text-foreground transition-all duration-300 hover:scale-110 group"
        title="随机文章"
      >
        <svg
          class="w-5 h-5 transition-transform duration-300 group-hover:rotate-180"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            fill="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M20 4v3.5a.3.3 0 0 1-.3.3H16a.3.3 0 0 1-.212-.512l1.147-1.146A8 8 0 0 0 4.34 8.54a.6.6 0 0 1-1.159-.308A10 10 0 0 1 18.207 4.54l1.147-1.146A.3.3 0 0 1 20 4zm-16 16v-3.5a.3.3 0 0 1 .3-.3H8a.3.3 0 0 1 .212.512L7.207 18A8 8 0 0 0 19.66 15.46a.6.6 0 0 1 1.159.308A10 10 0 0 1 5.793 19.46l-1.147 1.146A.3.3 0 0 1 4 20z"
          />
        </svg>
      </button>

      <ThemeSwitcher />
    </div>
    </nav>
  </div>

  <style>
    @media (max-width: 768px) {
      #nav-menu {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        border-top: 1px solid hsl(var(--border) / 0.3);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      #nav-menu.show {
        display: block !important;
      }
    }
  </style>

  <script>
    document.addEventListener("astro:page-load", function () {
      // 移动端菜单切换
      const navToggle = document.getElementById("nav-toggle");
      const navMenu = document.getElementById("nav-menu");

      if (navToggle && navMenu) {
        (navToggle as HTMLInputElement).addEventListener("change", function () {
          if ((this as HTMLInputElement).checked) {
            navMenu.classList.remove("hidden");
            navMenu.classList.add("show");
          } else {
            navMenu.classList.add("hidden");
            navMenu.classList.remove("show");
          }
        });
      }

      // 点击菜单项后关闭移动端菜单
      const menuLinks = document.querySelectorAll("#nav-menu a");
      menuLinks.forEach((link) => {
        link.addEventListener("click", function () {
          if (navToggle && navMenu) {
            (navToggle as HTMLInputElement).checked = false;
            navMenu.classList.add("hidden");
            navMenu.classList.remove("show");
          }
        });
      });

      // 随机文章按钮
      const randomBtn = document.getElementById("random-article-btn");
      if (randomBtn) {
        randomBtn.addEventListener("click", async function () {
          const button = this as HTMLButtonElement;
          const originalHTML = button.innerHTML;

          try {
            button.disabled = true;
            button.innerHTML =
              '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>';

            const response = await fetch("/api/blog-articles.json");
            if (!response.ok) throw new Error("无法获取文章列表");

            const articles = await response.json();
            if (!articles || articles.length === 0) throw new Error("没有找到可用的文章");

            const randomIndex = Math.floor(Math.random() * articles.length);
            window.location.href = `/blog/${articles[randomIndex].slug}`;
          } catch (error) {
            console.error("获取随机文章失败:", error);
            button.disabled = false;
            button.innerHTML = originalHTML;
            alert("获取随机文章失败，请稍后重试");
          }
        });
      }
    });
  </script>
</header>
