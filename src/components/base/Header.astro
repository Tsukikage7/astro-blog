---
import ThemeSwitcher from "@components/base/ThemeSwitcher.astro";
import { IoSearch } from "react-icons/io5";
import LiquidGlass from "@components/common/LiquidGlassLess.astro";
import GlassButton from "@components/ui/GlassButton.astro";
import { SITE_INFO } from "@lib/config";
import { Image } from "astro:assets";

const { pathname } = Astro.url;

const stickyHeader = true;

let siteName = SITE_INFO?.SITE_NAME || ""; 
let siteLogoUrl = SITE_INFO?.LOGO_IMAGE || "";

const menu = [
  {
    id: 1,
    name: "首页",
    url: "/",
    target: "_self",
    position: "header",
    parent_id: null,
    sort_order: 1,
    children: [],
  },
  {
    id: 2,
    name: "博客",
    url: "/blog",
    target: "_self",
    position: "header",
    parent_id: null,
    sort_order: 2,
    children: [],
  },
  {
    id: 3,
    name: "分类",
    url: "/blog/categories",
    target: "_self",
    position: "header",
    parent_id: null,
    sort_order: 3,
    children: [],
  },
  {
    id: 4,
    name: "动态",
    url: "/notes",
    target: "_self",
    position: "header",
    parent_id: null,
    sort_order: 4,
    children: [],
  },
  {
    id: 5,
    name: "音乐",
    url: "/music",
    target: "_self",
    position: "header",
    parent_id: null,
    sort_order: 5,
    children: [],
  },
  {
    id: 6,
    name: "关于",
    url: "/about",
    target: "_self",
    position: "header",
    parent_id: null,
    sort_order: 6,
    children: [],
  },
];
---

<header
  transition:persist
  class={`container px-3 lg:px-8 pb-6 z-30 lg:mt-4 lg:rounded-full ${stickyHeader && "sticky top-0"}`}
>
  <LiquidGlass
    enableGlassEffect={false}
    containerType="nav"
    wrapperClass="p-2.5 rounded-[35px] relative hover:bg-accent !transition-colors duration-500 !delay-300"
    textClass="min-h-12 md:min-h-14 flex flex-wrap items-center justify-start"
    effectClass="rounded-[35px]"
    tintClass="rounded-[35px]"
    shineClass="rounded-[35px]"
    animation="fadeDown"
  >
    
    <div class="order-0 flex ml-4 items-center">
      <a href="/" class="flex items-center">
        {
          siteLogoUrl && (
            <Image
              src={siteLogoUrl}
              alt={siteName}
              class="w-8 h-8 mx-1 rounded-full"
              width={32}
              height={32}
              eagerly-loaded={true}
            />
          )
        }

        {
          siteName && (
            <span class="text-xl font-bold justify-center text-txt-p dark:text-darkmode-txt-p">
              {siteName}
            </span>
          )
        }
      </a>
    </div>

    
    <input id="nav-toggle" type="checkbox" class="hidden" />
    <label
      for="nav-toggle"
      class="order-2 cursor-pointer flex items-center md:hidden text-txt-p dark:text-darkmode-txt-p lg:order-1"
    >
      <svg
        id="show-button"
        class="h-5 mx-2 fill-current block"
        viewBox="0 0 20 20"
      >
        <title>Menu Open</title>
        <path d="M0 3h20v2H0V3z m0 6h20v2H0V9z m0 6h20v2H0V0z"></path>
      </svg>
      <svg
        id="hide-button"
        class="h-5 mx-2 fill-current hidden"
        viewBox="0 0 20 20"
      >
        <title>Menu Close</title>
        <polygon
          points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2"
          transform="rotate(45 10 10)"></polygon>
      </svg>
    </label>
    
    <ul
      id="nav-menu"
      class="bg-card md:bg-inherit rounded-lg text-center relative order-3 hidden w-full p-4 md:order-1 md:flex md:w-auto md:space-x-1 md:p-0 md:mx-auto lg:space-x-2"
    >
      {
        menu.map((item: any) => (
          <li>
            <a
              href={item.url}
              target={item.target || "_self"}
              class={`flex items-center justify-center h-full my-4 md:my-0 border-none gap-2 px-1 font-bold text-txt-p transition-all duration-300 dark:text-darkmode-txt-p lg:px-2 rounded-xl relative z-10 hover:text-orange-600 dark:hover:text-orange-500 text-lg ${
                pathname === `${item.url}/` || pathname === item.url
                  ? "text-orange-500"
                  : ""
              }`}
            >
              <GlassButton
                variant="menu"
                size="menu"
                open={pathname === `${item.url}/` || pathname === item.url}
                className="!text-orange-300  w-full"
              >
                {item.icon && <span class="text-sm">{item.icon}</span>}
                {item.name}
              </GlassButton>
            </a>
          </li>
        ))
      }
    </ul>
    <div class="order-1 ml-auto flex items-center md:order-2">
      <a
        class="mr-4 inline-block border-border text-xl text-txt-p dark:border-darkmode-border dark:text-darkmode-txt-p"
        href="/search"
        aria-label="search"
        title="搜索"
      >
        <IoSearch />
      </a>

      
      <button
        id="random-article-btn"
        class="mr-4 p-2 text-orange-400 hover:text-orange-500 dark:text-orange-500 dark:hover:text-orange-400 transition-colors group"
        title="随机文章"
      >
        <svg
          class="w-5 h-5 transition-transform duration-300 group-hover:rotate-180"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            fill="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M20 4v3.5a.3.3 0 0 1-.3.3H16a.3.3 0 0 1-.212-.512l1.147-1.146A8 8 0 0 0 4.34 8.54a.6.6 0 0 1-1.159-.308A10 10 0 0 1 18.207 4.54l1.147-1.146A.3.3 0 0 1 20 4zm-16 16v-3.5a.3.3 0 0 1 .3-.3H8a.3.3 0 0 1 .212.512L7.207 18A8 8 0 0 0 19.66 15.46a.6.6 0 0 1 1.159.308A10 10 0 0 1 5.793 19.46l-1.147 1.146A.3.3 0 0 1 4 20z"
          />
        </svg>
      </button>

      <ThemeSwitcher />
    </div>
    
    
  </LiquidGlass>

  <style>
    
    .group:hover .submenu {
      opacity: 1 !important;
      visibility: visible !important;
    }

    
    @media (max-width: 768px) {
      #nav-menu {
        position: absolute;
        top: 120%;
        right: 0;
        width: calc(50%);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
      }

      #nav-menu.show {
        display: block !important;
      }

      
      .submenu {
        position: static !important;
        opacity: 1 !important;
        visibility: visible !important;
        transform: scale(1) !important;
        box-shadow: none !important;
        border: none !important;
        
        margin-top: 0.5rem;
        margin-left: 1rem;
        border-left: 2px solid rgba(249, 115, 22, 0.3);
        padding-left: 0.5rem;
      }

      
      .group > a {
        
        margin-bottom: 0;
      }
    }

    
    @media (max-width: 768px) {
      :global(.dark) .submenu {
        border-left-color: rgba(249, 115, 22, 0.5) !important;
      }

      :global(.dark) .group > a {
        border-bottom-color: rgba(255, 255, 255, 0.1) !important;
      }
    }

    
    #nav-menu .glass-button {
      transform: none !important;
    }

    #nav-menu .glass-button:hover {
      transform: none !important;
    }

    #nav-menu .glass-button:active {
      transform: none !important;
    }
  </style>

  <script>
    
    document.addEventListener("astro:page-load", () => {
      updateActiveMenuItem();
    });

    function updateActiveMenuItem() {
      const currentPath = window.location.pathname;
      const menuItems = document.querySelectorAll("#nav-menu a");

      
      menuItems.forEach((item) => {
        item.classList.remove("text-orange-500", "hover-active");
        item.children[0].className =
          "!gap-[inherit] !px-4 !py-2 border border-white/0 w-full";
      });

      
      const activeItem = Array.from(menuItems).find((item) => {
        const href = item.getAttribute("href");
        return (
          currentPath === href ||
          currentPath === href + "/" ||
          (href && href !== "/" && currentPath.indexOf(href) !== -1)
        );
      });

      
      if (activeItem) {
        
        activeItem.classList.add("text-orange-500");
        activeItem.children[0].className +=
          " glass-button glass-button--menu glass-button--menu dark:!text-orange-300 dark:!border-gray-400  w-full";
      }

      
      menuItems.forEach((item) => {
        
        item.removeEventListener("mouseenter", handleMenuItemHover);
        item.removeEventListener("mouseleave", handleMenuItemLeave);

        
        item.addEventListener("mouseenter", handleMenuItemHover);
        item.addEventListener("mouseleave", handleMenuItemLeave);
      });
    }

    
    function handleMenuItemHover(event: { currentTarget: any; }) {
      const item = event.currentTarget;
      const currentPath = window.location.pathname;
      const href = item.getAttribute("href");

      
      const isCurrentPage =
        currentPath === href ||
        currentPath === href + "/" ||
        (href && href !== "/" && currentPath.indexOf(href) !== -1);

      
      if (!isCurrentPage) {
        item.classList.add("text-orange-500", "hover-active");
        item.children[0].className +=
          " glass-button glass-button--menu glass-button--menu dark:!text-orange-300 dark:!border-gray-400  w-full";
      }
    }

    
    function handleMenuItemLeave(event: { currentTarget: any; }) {
      const item = event.currentTarget;
      const currentPath = window.location.pathname;
      const href = item.getAttribute("href");

      
      const isCurrentPage =
        currentPath === href ||
        currentPath === href + "/" ||
        (href && href !== "/" && currentPath.indexOf(href) !== -1);

      
      if (!isCurrentPage) {
        item.classList.remove("text-orange-500", "hover-active");
        item.children[0].className =
          "!gap-[inherit] !px-4 !py-2 border border-white/0 w-full";
      }
    }

    
    document.addEventListener("astro:page-load", function () {
      const navToggle = document.getElementById("nav-toggle");
      const navMenu = document.getElementById("nav-menu");

      
      if (navToggle && navMenu) {
        (navToggle as HTMLInputElement).addEventListener("change", function () {
          if ((this as HTMLInputElement).checked) {
            navMenu.classList.remove("hidden");
            navMenu.classList.add("show");
          } else {
            navMenu.classList.add("hidden");
            navMenu.classList.remove("show");
          }
        });
      }

      
      const menuLinks = document.querySelectorAll("#nav-menu a");
      menuLinks.forEach((link) => {
        link.addEventListener("click", function () {
          if (navToggle && navMenu) {
            (navToggle as HTMLInputElement).checked = false;
            navMenu.classList.add("hidden");
            navMenu.classList.remove("show");
          }
        });
      });

      
      

      
      const dropdownItems = document.querySelectorAll(".dropdown");
      dropdownItems.forEach((dropdown) => {
        const toggle = dropdown.querySelector(".dropdown-toggle");
        const menu = dropdown.querySelector(".dropdown-menu");

        if (toggle && menu) {
          toggle.addEventListener("click", function (e) {
            e.preventDefault();
            dropdown.classList.toggle("active");
          });

          
          document.addEventListener("click", function (e) {
            if (!dropdown.contains(e.target as Node)) {
              dropdown.classList.remove("active");
            }
          });
        }
      });
    });

    
    document.addEventListener("astro:page-load", function () {
      const randomBtn = document.getElementById("random-article-btn");
      if (randomBtn) {
        randomBtn.addEventListener("click", async function () {
          const button = this as HTMLButtonElement;
          const originalHTML = button.innerHTML; 

          try {
            
            button.disabled = true;
            button.innerHTML =
              '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>';

            
            const response = await fetch("/api/blog-articles.json");
            if (!response.ok) {
              throw new Error("无法获取文章列表");
            }
            const articles = await response.json();
            if (!articles || articles.length === 0) {
              throw new Error("没有找到可用的文章");
            }
            

            
            const randomIndex = Math.floor(Math.random() * articles.length);
            const randomArticle = articles[randomIndex];

            
            window.location.href = `/blog/${randomArticle.slug}`;
          } catch (error) {
            console.error("获取随机文章失败:", error);
            
            button.disabled = false;
            button.innerHTML = originalHTML;

            
            alert("获取随机文章失败，请稍后重试");
          }
        });
      }
    });

    
    updateActiveMenuItem();
  </script>
</header>
