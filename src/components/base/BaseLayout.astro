---
import { plainify } from "@lib/textConverter";
import Footer from "@components/base/Footer.astro";
import Header from "@components/base/Header.astro";
import MusicPlayer from "@components/common/MusicPlayer.astro";
import "@/styles/main.scss";
import { ClientRouter } from "astro:transitions";
import Background from "@/components/base/Background.astro";
import { Tooltips } from "astro-tooltips";
import { SITE_INFO, MUSIC_PLAYER_CONFIG } from "@lib/config";
import { isDevelopment } from "@lib/env";

export interface Props {
  title?: string;
  description?: string | null;
  image?: string;
  noindex?: boolean;
  canonical?: string;
  keywords?: string;
}

const { title, description, image, noindex, canonical, keywords } = Astro.props;

// Check if current page is music page (to hide floating player)
const isMusicPage = Astro.url.pathname === '/music' || Astro.url.pathname === '/music/';

let basicSettings: any = {};
let seoSettings: any = {};
let customSettings: any = {};

const siteTitle = SITE_INFO.SITE_NAME;
const siteSubTitle = SITE_INFO.SUBNAME;
const siteImage = SITE_INFO.LOGO_IMAGE || "/favicon.ico";
const baseUrl = SITE_INFO.URL || "/";
const siteKeywords = basicSettings?.site_keywords || "";
const siteTagline = basicSettings?.site_tagline || "";

const metaTitle = seoSettings?.seo_meta_title || "";
const metaDescription = description || SITE_INFO.DESCRIPTION;
const metaKeywords = keywords || SITE_INFO.KEY_WORDS;
const googleAnalyticsId = SITE_INFO.GOOGLE_ANALYTICS_ID || "";
const baiduAnalyticsId = SITE_INFO.BAIDU_ANALYTICS_ID || "";

const customHeaderCode = customSettings?.custom_header_code || "";
const customFooterCode = customSettings?.custom_footer_code || "";
---

<!DOCTYPE html>
<html lang="en">
  <head>
    
    <link
      rel="logo-192x192"
      sizes="180x180"
      href="/favicon/logo-192x192.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/favicon/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/favicon/favicon-16x16.png"
    />

    <link rel="sitemap" href="/sitemap-index.xml" />
    
    <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/rss.xml" />

    <meta name="theme-name" content="pages" />
    <meta name="msapplication-TileColor" content="#000000" />
    <meta
      name="theme-color"
      media="(prefers-color-scheme: light)"
      content="#fff"
    />
    <meta
      name="theme-color"
      media="(prefers-color-scheme: dark)"
      content="#000"
    />
    <meta name="generator" content={Astro.generator} />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=5"
    />

    <title>
      {title ? plainify(title) + " | " : ""}{siteTitle + " | " + siteSubTitle}
    </title>

    {canonical && <link rel="canonical" href={canonical} item-prop="url" />}

    <meta
      name="description"
      content={plainify(description ? description : metaDescription)}
    />
    {metaKeywords && <meta name="keywords" content={metaKeywords} />}

    <meta
      property="og:title"
      content={`${plainify(metaTitle + " " + siteTagline)}`}
    />
    <meta
      property="og:description"
      content={plainify(description ? description : metaDescription)}
    />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content={`${baseUrl}/${Astro.url.pathname.replace("/", "")}`}
    />
    <meta
      property="og:image"
      content={`${baseUrl}${image ? image : siteImage}`}
    />

    <meta
      name="twitter:title"
      content={`${plainify(metaTitle + " " + siteTagline)}`}
    />
    <meta
      name="twitter:description"
      content={plainify(description ? description : metaDescription)}
    />
    <meta
      name="twitter:image"
      content={`${baseUrl}${image ? image : siteImage}`}
    />
    <meta name="twitter:card" content="summary_large_image" />

    
    
    
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link
      rel="preconnect"
      href="https://www.googletagmanager.com"
      crossorigin
    />
    <link rel="preconnect" href="https://hm.baidu.com" crossorigin />

    
    <link rel="dns-prefetch" href="
    <link rel="dns-prefetch" href="

    
    <link
      rel="preload"
      as="style"
      href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
      onload="this.rel='stylesheet'"
    />
    <noscript>
      <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css"
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
      />
    </noscript>
    
    <link
      rel="preload"
      as="script"
      href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"
      crossorigin="anonymous"
    />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
      defer></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
      defer></script>
    <script
      src="https://cdn.jsdelivr.net/npm/twikoo@1.6.44/dist/twikoo.min.js"
      integrity="sha384-dZ/hSVfTPHuzXyECOYCetAvMd0cgqWxN5Fh+mwo86PV4GdU9xgQ/MNzh/YM/lotR"
      crossorigin="anonymous"
      defer></script>
    
    <ClientRouter fallback="swap" />
    <Tooltips interactive={false} delay={[100, 50]} />

    
    {
      !isDevelopment() && googleAnalyticsId && (
        <>
          <script
            async
            src={`https://www.googletagmanager.com/gtag/js?id=${googleAnalyticsId}`}
          />
          <script
            set:html={`
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', '${googleAnalyticsId}');
        `}
          />
        </>
      )
    }

    
    {
      !isDevelopment() && baiduAnalyticsId && (
        <script
          set:html={`
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?${baiduAnalyticsId}";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
      `}
        />
      )
    }
    <meta name="baidu-site-verification" content="codeva-RmOcCYpW8H" />
    
    {customHeaderCode && <Fragment set:html={customHeaderCode} />}

    
    <style>
      
      .page-loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: hsl(var(--background) / 0.98);
        backdrop-filter: blur(8px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition:
          opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
          visibility 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .page-loading.active {
        opacity: 1;
        visibility: visible;
      }

      
      .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
        padding: 1.5rem;
      }

      
      .loading-spinner {
        width: 2rem;
        height: 2rem;
        color: hsl(var(--primary));
        animation: spin 1s linear infinite;
      }

      
      .loading-text {
        font-size: 0.875rem;
        font-weight: 500;
        color: hsl(var(--muted-foreground));
        letter-spacing: -0.025em;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      
      html {
        view-transition-name: root;
      }

      ::view-transition-old(root),
      ::view-transition-new(root) {
        animation-duration: 0.3s;
      }

      ::view-transition-old(root) {
        animation-name: fade-out;
      }

      ::view-transition-new(root) {
        animation-name: fade-in;
      }

      @keyframes fade-out {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }

      @keyframes fade-in {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
    </style>

    
  </head>
  <body>
    
    <svg style="position: absolute; width: 0; height: 0; pointer-events: none;">
      <defs>
        <filter
          id="glass-distortion"
          x="0%"
          y="0%"
          width="100%"
          height="100%"
          filterUnits="objectBoundingBox"
        >
          <feTurbulence
            type="fractalNoise"
            baseFrequency="0.001 0.004"
            numOctaves="1"
            seed="17"
            result="turbulence"></feTurbulence>
          

          <feComponentTransfer in="turbulence" result="mapped">
            <feFuncR type="gamma" amplitude="1" exponent="10" offset="0.5"
            ></feFuncR>
            <feFuncG type="gamma" amplitude="0" exponent="1" offset="0"
            ></feFuncG>
            <feFuncB type="gamma" amplitude="0" exponent="1" offset="0.5"
            ></feFuncB>
          </feComponentTransfer>

          <feGaussianBlur in="turbulence" stdDeviation="3" result="softMap"
          ></feGaussianBlur>

          <feSpecularLighting
            in="softMap"
            surfaceScale="5"
            specularConstant="1"
            specularExponent="100"
            lighting-color="white"
            result="specLight"
          >
            <fePointLight x="-200" y="-200" z="300"></fePointLight>
          </feSpecularLighting>

          <feComposite
            in="specLight"
            operator="arithmetic"
            k1="0"
            k2="1"
            k3="1"
            k4="0"
            result="litImage"></feComposite>

          <feDisplacementMap
            in="SourceGraphic"
            in2="softMap"
            scale="100"
            xChannelSelector="R"
            yChannelSelector="G"></feDisplacementMap>
        </filter>
      </defs>
    </svg>

    
    <div class="page-loading">
      <div class="loading-container">
        
        <svg
          class="loading-spinner"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M21 12a9 9 0 1 1-6.219-8.56" />
        </svg>
        <div class="loading-text" id="loading-text">加载中...</div>
      </div>
    </div>

    <Background />
    <Header />
    <main id="main-content" class="flex-1 pb-16 md:pb-36">
      <slot />
    </main>
    <Footer />
    {MUSIC_PLAYER_CONFIG.ENABLED && !isMusicPage && <MusicPlayer />}
    
    
    <script>
      
      function renderMathSafely() {
        if (
          typeof (window as any).renderMathInElement !== "undefined" &&
          document.body
        ) {
          try {
            (window as any).renderMathInElement(document.body, {
              delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true },
              ],
              throwOnError: false,
            });
          } catch (error) {
            console.warn("KaTeX rendering failed:", error);
          }
        }
      }

      
      document.addEventListener("DOMContentLoaded", renderMathSafely);

      
      document.addEventListener("astro:page-load", renderMathSafely);

      
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", renderMathSafely);
      } else {
        renderMathSafely();
      }
    </script>

    
    <script>
      
      let loadingTimeout: NodeJS.Timeout | null = null;

      
      const loadingTexts = [
        "加载中...",
        "正在准备...",
        "稍等片刻...",
        "内容加载中...",
      ];

      function getRandomLoadingText() {
        return loadingTexts[Math.floor(Math.random() * loadingTexts.length)];
      }

      function updateLoadingText() {
        const textElement = document.getElementById("loading-text");
        if (textElement) {
          textElement.textContent = getRandomLoadingText();
        }
      }

      function showPageLoading(delay = 0) {
        
        if (loadingTimeout) {
          clearTimeout(loadingTimeout);
          loadingTimeout = null;
        }

        const loadingElement = document.querySelector(".page-loading");
        if (loadingElement) {
          
          updateLoadingText();

          if (delay > 0) {
            
            requestAnimationFrame(() => {
              setTimeout(() => {
                loadingElement.classList.add("active");
              }, delay);
            });
          } else {
            
            requestAnimationFrame(() => {
              loadingElement.classList.add("active");
            });
          }
        }
      }

      function hidePageLoading(delay = 100) {
        const loadingElement = document.querySelector(".page-loading");
        if (loadingElement) {
          
          loadingTimeout = setTimeout(() => {
            requestAnimationFrame(() => {
              loadingElement.classList.remove("active");
            });
            loadingTimeout = null;
          }, delay);
        }
      }

      
      function isQuickNavigation() {
        return (
          document.readyState === "complete" ||
          document.readyState === "interactive"
        );
      }

      
      document.addEventListener("astro:before-preparation", () => {
        
        const delay = isQuickNavigation() ? 150 : 0;
        showPageLoading(delay);
      });

      
      document.addEventListener("astro:page-load", () => {
        hidePageLoading();
      });

      
      document.addEventListener("click", (e) => {
        const target = e.target as HTMLElement;
        const link = target.closest("a");

        if (link && link.href) {
          const url = new URL(link.href);
          const currentUrl = new URL(window.location.href);

          
          if (url.origin === currentUrl.origin && !url.hash) {
            
            const isDownload =
              link.hasAttribute("download") ||
              link.href.match(/\.(pdf|doc|docx|zip|rar|exe|dmg)$/i);
            const isExternal = link.target === "_blank";
            const isMailto = link.href.startsWith("mailto:");
            const isTel = link.href.startsWith("tel:");
            const isAnchor = link.getAttribute("href")?.startsWith("#");

            
            if (
              !isDownload &&
              !isExternal &&
              !isMailto &&
              !isTel &&
              !isAnchor
            ) {
              
              if (url.pathname !== currentUrl.pathname) {
                showPageLoading();
              }
            }
          }
        }
      });

      
      window.addEventListener("popstate", () => {
        showPageLoading();
      });

      
      document.addEventListener("submit", (e) => {
        const form = e.target as HTMLFormElement;
        if (form && form.method.toLowerCase() === "get") {
          showPageLoading();
        }
      });

      
      document.addEventListener("DOMContentLoaded", () => {
        hidePageLoading();
      });

      
      if (document.readyState === "complete") {
        hidePageLoading();
      }

      
    </script>

    
    {customFooterCode && <Fragment set:html={customFooterCode} />}
  </body>
</html>
