---
import BaseLayout from "@components/base/BaseLayout.astro";
import { plainify } from "@lib/textConverter";
import { render, type CollectionEntry, getCollection } from "astro:content";
import TableOfContents from "@components/common/TableOfContents.astro";
import "../../styles/markdown.scss";
import { SITE_INFO } from "@lib/config";
import LiquidGlassLess from "@components/common/LiquidGlassLess.astro";
import ShareButton from "@components/blog/ShareButton.astro";
import { formatDate } from "@lib/formatDate";
import readingTime from "@lib/readingTime";
import type { WritingsEntry } from "@/types";

interface Props {
  entry: CollectionEntry<"writings">;
}

const { entry } = Astro.props;
const { title, description, image, updated, created, genre, series, seriesOrder, mood, tags } = entry.data;

const { headings } = await render(entry);

const descriptionLength = 200;
const tocDepth = 3;

const actuallyHideToc = headings.filter((heading) => heading.depth <= tocDepth).length < 3;

const articleClass = actuallyHideToc ? "w-full lg:w-4/5 mx-auto" : "w-full lg:w-3/4";
const tocClass = actuallyHideToc ? "hidden" : "hidden lg:flex lg:w-1/4";

const entryDescription =
  description ||
  (entry.body ? plainify(entry.body.slice(0, descriptionLength)) : "");

const entryDate = created ? formatDate(created) : null;
const entryReadingTime = readingTime(entry.body!, 1);

// 获取同系列的其他文章
let seriesEntries: WritingsEntry[] = [];
if (series) {
  const allWritings = await getCollection("writings", ({ data }) => !data.draft);
  seriesEntries = allWritings
    .filter((w) => w.data.series === series && w.id !== entry.id)
    .sort((a, b) => (a.data.seriesOrder || 0) - (b.data.seriesOrder || 0)) as WritingsEntry[];
}

// 体裁配置 - 使用灰度
const genreConfig: Record<string, { color: string }> = {
  "短篇小说": { color: "text-zinc-600 dark:text-zinc-400" },
  "散文": { color: "text-stone-600 dark:text-stone-400" },
  "诗歌": { color: "text-neutral-600 dark:text-neutral-400" },
  "杂文": { color: "text-gray-600 dark:text-gray-400" },
  "随笔": { color: "text-slate-600 dark:text-slate-400" },
};

const currentGenre = genre ? genreConfig[genre] : null;
---

<BaseLayout title={title} description={entryDescription} image={image?.src}>
  <section class="flex container px-3 lg:px-8">
    <div class:list={[articleClass]}>
      <article>
        <!-- 文章头部 -->
        <LiquidGlassLess
          heavy
          wrapperClass="dock rounded-xl p-6 lg:p-8 mb-6"
        >
          <!-- 元信息 -->
          <div class="flex flex-wrap items-center gap-3 mb-4 text-sm">
            {currentGenre && (
              <span class={`inline-flex items-center font-medium ${currentGenre.color}`}>
                {genre}
              </span>
            )}
            {series && (
              <span class="inline-flex items-center text-zinc-600 dark:text-zinc-400">
                {series}
                {seriesOrder && <span class="ml-1 opacity-70">#{seriesOrder}</span>}
              </span>
            )}
            {mood && (
              <span class="text-txt-light dark:text-darkmode-txt-light opacity-70">
                {mood}
              </span>
            )}
          </div>

          <!-- 标题 -->
          <h1 class="text-3xl lg:text-4xl font-bold text-txt-p dark:text-darkmode-txt-p mb-4 leading-tight">
            {title}
          </h1>

          <!-- 描述 -->
          {description && (
            <p class="text-lg text-txt-light dark:text-darkmode-txt-light mb-4 leading-relaxed italic border-l-4 border-border pl-4">
              {description}
            </p>
          )}

          <!-- 底部信息 -->
          <div class="flex flex-wrap items-center justify-between pt-4 border-t border-border/30">
            <div class="flex items-center gap-4 text-sm text-txt-light dark:text-darkmode-txt-light">
              {entryDate && (
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  {entryDate}
                </span>
              )}
              <span class="flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                {entryReadingTime}
              </span>
            </div>
            {tags && tags.length > 0 && (
              <div class="flex items-center gap-2 mt-2 sm:mt-0">
                {tags.map((tag) => (
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-muted/60 text-muted-foreground">
                    #{tag}
                  </span>
                ))}
              </div>
            )}
          </div>
        </LiquidGlassLess>

        <!-- 文章内容 -->
        <LiquidGlassLess
          heavy
          wrapperClass="panel flex flex-col justify-between mb-4 rounded-xl intersect-no-queue min-h-96"
        >
          <div
            class="p-4 lg:p-8 prose prose-lg max-w-none markdown-content text-txt-p dark:text-darkmode-txt-p intersect:animate-fadeUp"
          >
            <slot />
          </div>
        </LiquidGlassLess>

        <!-- 系列文章 -->
        {seriesEntries.length > 0 && (
          <LiquidGlassLess
            heavy
            wrapperClass="dock rounded-xl p-6 mb-4"
          >
            <h3 class="text-lg font-bold text-txt-p dark:text-darkmode-txt-p mb-4">
              {series} 系列
            </h3>
            <div class="space-y-2">
              {seriesEntries.map((seriesEntry) => (
                <a
                  href={`/writings/${seriesEntry.id}`}
                  class="block p-3 rounded-xl bg-muted/30 hover:bg-muted/50 transition-colors duration-200"
                >
                  <div class="flex items-center justify-between">
                    <span class="font-medium text-txt-p dark:text-darkmode-txt-p">
                      {seriesEntry.data.seriesOrder && (
                        <span class="text-muted-foreground mr-2">
                          #{seriesEntry.data.seriesOrder}
                        </span>
                      )}
                      {seriesEntry.data.title}
                    </span>
                    <svg class="w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                  </div>
                </a>
              ))}
            </div>
          </LiquidGlassLess>
        )}

        <!-- 作者信息和分享 -->
        <div class="relative mt-6">
          <LiquidGlassLess
            heavy
            wrapperClass="dock rounded-xl pt-6 pb-6 px-6"
            textClass="intersect-no-queue"
          >
            <div class="flex items-center justify-center gap-4 mb-4">
              <ShareButton
                title={title}
                description={entryDescription}
                folder="writings"
                id={entry.id}
              />
            </div>

            <div class="w-full h-px bg-gradient-to-r from-transparent via-white/20 to-transparent mb-4"></div>

            <div class="text-center text-xs text-muted-foreground/70 space-y-2">
              <div class="flex flex-wrap items-center justify-center gap-1">
                <span>© 2025</span>
                <a href={SITE_INFO.URL} class="hover:text-foreground transition-colors">{SITE_INFO.SITE_NAME}</a>
                <span>·</span>
                <a
                  target="_blank"
                  href="https://creativecommons.org/licenses/by-nc-sa/4.0/"
                  class="hover:text-foreground transition-colors"
                >
                  CC BY-NC-SA 4.0
                </a>
              </div>
              {updated && (
                <div class="flex items-center justify-center gap-1">
                  <span>更新于</span>
                  <span>{new Date(updated).toLocaleDateString("zh-CN")}</span>
                </div>
              )}
              </div>
            </div>
          </LiquidGlassLess>
        </div>
      </article>
    </div>

    <!-- 目录 -->
    {!actuallyHideToc && (
      <div class="flex-col h-full sticky top-[4rem] ml-4 space-y-4 hidden lg:flex lg:w-1/4">
        <TableOfContents headings={headings} tocDepth={tocDepth} />
      </div>
    )}
  </section>
</BaseLayout>

<script>
  // 代码块收起/展开功能（使用 grid 动画，参考内容导航）
  function setupCodeCollapse() {
    const codeBlocks = document.querySelectorAll('.markdown-content pre.astro-code');

    codeBlocks.forEach((pre) => {
      // 避免重复处理
      if (pre.closest('.code-collapse-wrapper')) return;

      const code = pre.querySelector('code');
      const lines = code ? code.querySelectorAll('.line').length : 0;
      const language = pre.getAttribute('data-language') || 'code';

      // 创建包装器
      const wrapper = document.createElement('div');
      wrapper.className = 'code-collapse-wrapper';

      // 创建头部
      const header = document.createElement('div');
      header.className = 'code-collapse-header';
      header.setAttribute('aria-expanded', 'false');
      header.innerHTML = `
        <div class="code-collapse-title">
          <svg class="code-collapse-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
          <span class="code-collapse-text">${language.toUpperCase()}</span>
          ${lines > 0 ? `<span class="code-collapse-count">${lines} 行</span>` : ''}
        </div>
        <div class="code-collapse-actions">
          <button class="code-collapse-copy-btn" type="button" title="复制代码">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="code-collapse-action-text">复制</span>
          </button>
          <button class="code-collapse-btn" type="button">
            <span class="code-collapse-action-text">展开</span>
          </button>
        </div>
      `;

      // 创建内容容器（用于 grid 动画）
      const content = document.createElement('div');
      content.className = 'code-collapse-content'; // 默认收起

      // 创建内部包装器
      const inner = document.createElement('div');
      inner.className = 'code-collapse-inner';

      // 组装 DOM 结构
      pre.parentNode?.insertBefore(wrapper, pre);
      inner.appendChild(pre);
      content.appendChild(inner);
      wrapper.appendChild(header);
      wrapper.appendChild(content);

      // 收起/展开点击事件
      const toggleBtn = header.querySelector('.code-collapse-btn');
      const toggleAction = () => {
        const isExpanded = header.getAttribute('aria-expanded') === 'true';
        header.setAttribute('aria-expanded', String(!isExpanded));
        content.classList.toggle('code-collapse-content--expanded', !isExpanded);

        const icon = header.querySelector('.code-collapse-icon') as HTMLElement;
        const btnText = toggleBtn?.querySelector('.code-collapse-action-text');

        if (icon) {
          icon.style.transform = !isExpanded ? 'rotate(180deg)' : 'rotate(0deg)';
        }
        if (btnText) {
          btnText.textContent = !isExpanded ? '收起' : '展开';
        }
      };

      toggleBtn?.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleAction();
      });

      // 点击头部也可以展开/收起
      header.addEventListener('click', (e) => {
        if ((e.target as HTMLElement).closest('.code-collapse-copy-btn')) return;
        if ((e.target as HTMLElement).closest('.code-collapse-btn')) return;
        toggleAction();
      });

      // 复制功能
      const copyBtn = header.querySelector('.code-collapse-copy-btn');
      copyBtn?.addEventListener('click', async (e) => {
        e.stopPropagation();
        const codeText = code?.textContent || '';

        try {
          await navigator.clipboard.writeText(codeText);
          const copyText = copyBtn.querySelector('.code-collapse-action-text');
          if (copyText) {
            copyText.textContent = '已复制';
            setTimeout(() => {
              copyText.textContent = '复制';
            }, 2000);
          }
        } catch (err) {
          console.error('复制失败:', err);
        }
      });
    });
  }

  // 初始化
  document.addEventListener('DOMContentLoaded', setupCodeCollapse);
  document.addEventListener('astro:page-load', setupCodeCollapse);
</script>
