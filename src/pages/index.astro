---
import BaseLayout from "@components/base/BaseLayout.astro";
import type { BlogEntry } from "@/types";
import { type CollectionEntry } from "astro:content";
import { sortByDate } from "@lib/sortFunctions";
import { getEntries } from "@lib/contentParser";
import { formatDate } from "@lib/formatDate";
import { plainify } from "@lib/textConverter";
import ArticleCalendar from "@components/home/ArticleCalendar.astro";
import HomeNotesPreview from "@components/notes/HomeNotesPreview.astro";
import SmartImage from "@components/common/SmartImage.astro";
import PlaceholderImage from "@components/blog/PlaceholderImage.astro";

const allPosts = (await getEntries("blog", sortByDate)) as BlogEntry[];
const recentPosts = allPosts.slice(0, 5);

const latestNotes = (await getEntries("notes", sortByDate)) as CollectionEntry<"notes">[];

// 获取文字内容
const allWritings = (await getEntries("writings", sortByDate)) as CollectionEntry<"writings">[];

// 合并博客和文字，按日期排序
type GalleryItem = { type: "blog"; data: BlogEntry } | { type: "writing"; data: CollectionEntry<"writings"> };
const galleryItems: GalleryItem[] = [
  ...allPosts.map((post) => ({ type: "blog" as const, data: post })),
  ...allWritings.map((writing) => ({ type: "writing" as const, data: writing })),
].sort((a, b) => {
  const dateA = a.type === "blog" ? a.data.data.date : a.data.data.date;
  const dateB = b.type === "blog" ? b.data.data.date : b.data.data.date;
  return new Date(dateB || 0).getTime() - new Date(dateA || 0).getTime();
}).slice(0, 12);

// 分类统计
const allCategories = allPosts.flatMap((post) => post.data.categories || []).filter(Boolean);
const uniqueCategories = [...new Set(allCategories)].sort();
const categories = uniqueCategories.slice(0, 6).map((category) => ({
  name: category,
  count: allPosts.filter((post) => post.data.categories?.includes(category)).length,
  slug: category?.toLowerCase().replace(/\s+/g, "-"),
}));

// 获取文章图片
const hasImage = (post: BlogEntry) => {
  return post.data.image && (typeof post.data.image === "string" || (typeof post.data.image === "object" && "src" in post.data.image));
};
---

<BaseLayout>
  <div class="py-8">

    <!-- 最新内容（博客+文字混合） -->
    <section class="mb-16">
      <div class="px-6 mb-6 flex items-center justify-between">
        <h2 class="text-2xl font-medium text-foreground">最新内容</h2>
      </div>

      <div class="gallery-scroll flex gap-5 overflow-x-auto pl-6 pb-6 snap-x snap-mandatory">
        {galleryItems.map((item, index) => {
          if (item.type === "blog") {
            const post = item.data;
            const dateStr = post.data.date ? formatDate(post.data.date) : "";
            return (
              <a
                href={`/blog/${post.id}`}
                class="group flex-shrink-0 snap-start w-[85vw] md:w-[420px]"
              >
                <article class="h-full">
                  <div class="relative overflow-hidden rounded-xl bg-muted/30 aspect-[16/10]">
                    {hasImage(post) ? (
                      <SmartImage
                        src={post.data.image}
                        alt={post.data.imageAlt || post.data.title}
                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                        loading={index < 3 ? "eager" : "lazy"}
                        quality={75}
                      />
                    ) : (
                      <PlaceholderImage title={post.data.title} className="w-full h-full" />
                    )}
                  </div>
                  <div class="mt-4 pr-4">
                    <div class="flex items-center gap-2 text-sm text-muted-foreground/60">
                      <span>博客</span>
                      {dateStr && <span>·</span>}
                      {dateStr && <time>{dateStr}</time>}
                    </div>
                    <h3 class="mt-1.5 text-lg font-medium text-foreground group-hover:text-foreground/70 transition-colors line-clamp-2">
                      {post.data.title}
                    </h3>
                    {post.data.description && (
                      <p class="mt-2 text-base text-muted-foreground line-clamp-2">
                        {post.data.description}
                      </p>
                    )}
                  </div>
                </article>
              </a>
            );
          } else {
            const writing = item.data;
            const dateStr = writing.data.date ? formatDate(writing.data.date) : "";
            const preview = writing.body ? plainify(writing.body).slice(0, 100) + "..." : "";
            return (
              <a
                href={`/writings/${writing.id}`}
                class="group flex-shrink-0 snap-start w-[85vw] md:w-[420px]"
              >
                <article class="h-full">
                  <div class="relative overflow-hidden rounded-xl bg-muted/30 aspect-[16/10]">
                    <PlaceholderImage title={writing.data.title} className="w-full h-full" />
                  </div>
                  <div class="mt-4 pr-4">
                    <div class="flex items-center gap-2 text-sm text-muted-foreground/60">
                      <span>{writing.data.genre || "文字"}</span>
                      {dateStr && <span>·</span>}
                      {dateStr && <time>{dateStr}</time>}
                    </div>
                    <h3 class="mt-1.5 text-lg font-medium text-foreground group-hover:text-foreground/70 transition-colors line-clamp-2">
                      {writing.data.title}
                    </h3>
                    <p class="mt-2 text-base text-muted-foreground line-clamp-2">
                      {writing.data.description || preview}
                    </p>
                  </div>
                </article>
              </a>
            );
          }
        })}
        <div class="flex-shrink-0 w-6"></div>
      </div>
    </section>

    <!-- 三栏区域 -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-10 md:gap-16 py-12 px-6 border-t border-border/20">

      <!-- 分类 -->
      <div>
        <h3 class="text-lg font-medium text-foreground mb-6 flex items-center gap-2">
          <svg class="w-5 h-5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A2 2 0 013 12V7a4 4 0 014-4z" />
          </svg>
          分类
        </h3>
        <div class="space-y-1">
          {categories.map((cat) => (
            <a
              href={`/blog/categories/${cat.slug}`}
              class="flex items-center justify-between py-3 text-base text-muted-foreground hover:text-foreground transition-colors group"
            >
              <span class="flex items-center gap-2">
                <span class="w-1 h-1 rounded-full bg-border group-hover:bg-foreground/50 transition-colors"></span>
                {cat.name}
              </span>
              <span class="text-sm text-muted-foreground/40 group-hover:text-muted-foreground/70 transition-colors tabular-nums">
                {cat.count}
              </span>
            </a>
          ))}
        </div>
      </div>

      <!-- 推荐阅读 -->
      <div>
        <h3 class="text-lg font-medium text-foreground mb-6 flex items-center gap-2">
          <svg class="w-5 h-5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
          </svg>
          推荐
        </h3>
        <div class="space-y-4">
          {recentPosts.map((post) => (
            <a
              href={`/blog/${post.id}`}
              class="block text-base text-muted-foreground hover:text-foreground transition-colors line-clamp-2"
            >
              {post.data.title}
            </a>
          ))}
        </div>
      </div>

      <!-- 站点动态 -->
      <div class="notes-preview-compact">
        <HomeNotesPreview entries={latestNotes} limit={4} />
      </div>

    </section>

    <!-- 日历热力图 -->
    <section class="py-12 px-6 border-t border-border/20">
      <ArticleCalendar />
    </section>

  </div>
</BaseLayout>

<style>
  .gallery-scroll {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  .gallery-scroll::-webkit-scrollbar {
    display: none;
  }
</style>
