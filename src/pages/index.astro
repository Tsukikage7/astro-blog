---
import BaseLayout from "@components/base/BaseLayout.astro";
import Button from "@components/common/Button.astro";
import BlogCard from "@components/blog/Card.astro";
import type { BlogEntry } from "@/types";
import LiquidGlass from "@components/common/LiquidGlassLess.astro";
import HomeNotesPreview from "@components/notes/HomeNotesPreview.astro";
import ArticleCalendar from "@components/home/ArticleCalendar.astro";
import AuthorProfile from "@components/home/AuthorProfile.astro";
import { type CollectionEntry } from "astro:content";
import { getSiteStats } from "@lib/contentParser";
import { sortByDate } from "@lib/sortFunctions";
import { getEntries } from "@lib/contentParser";
import RecommendedReadCardComponent from "@components/blog/RecommendedReadCard.astro";

const allPosts = (await getEntries("blog", sortByDate)) as BlogEntry[];
const publishedPosts = allPosts
  .filter((post) => post.data.status === "published")
  .sort((a, b) => {
    const dateA = new Date(a.data.publishedAt || 0);
    const dateB = new Date(b.data.publishedAt || 0);
    return dateB.getTime() - dateA.getTime();
  });

const latestNotes = (await getEntries(
  "notes",
  sortByDate,
)) as CollectionEntry<"notes">[];

const featuredPosts = (
  (await getEntries("blog", sortByDate)) as BlogEntry[]
).slice(0, 8);

const allCategories = publishedPosts
  .flatMap((post) => post.data.categories || [])
  .filter(Boolean);
const uniqueCategories = [...new Set(allCategories)].sort();
const categories = uniqueCategories.map((category) => ({
  name: category,
  count: publishedPosts.filter((post) =>
    post.data.categories?.includes(category),
  ).length,
  id: category,
  slug: category?.toLowerCase().replace(/\s+/g, "-"),
}));

const recommendedPosts = featuredPosts.slice(0, 4);

const siteStats = await getSiteStats();
---

<BaseLayout>
  <div class="container px-3 lg:px-8">
    
    <section class="rounded-[35px] mb-4">
      <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
        
        <div class="xl:col-span-1">
          <LiquidGlass heavy textClass="h-full">
            <div class="rounded-[35px] intersect:animate-fadeUp h-full">
              <AuthorProfile />
            </div>
          </LiquidGlass>
        </div>

        
        <div class="hidden md:block xl:col-span-2 h-full">
          <LiquidGlass
            heavy
            containerClass="h-full"
            wrapperClass="dock h-full"
            textClass="p-3"
          >
            <div class="rounded-lg intersect:animate-fadeUp h-full">
              <ArticleCalendar />
            </div>
          </LiquidGlass>
        </div>
      </div>
    </section>

    <section class="rounded-lg mb-6">
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        {
          categories.slice(0, 6).map((category: any, index: number) => (
            <a
              href={`/blog/categories/${category.slug}`}
              class="group relative flex items-center justify-between px-4 py-3 rounded-lg border border-border bg-card text-card-foreground hover:bg-accent hover:text-accent-foreground transition-all duration-200 shadow-sm hover:shadow-md intersect:animate-fadeUp"
              style={`animation-delay: ${index * 100}ms`}
            >
              <div class="flex items-center gap-2 min-w-0">
                <svg
                  class="w-4 h-4 text-muted-foreground group-hover:text-accent-foreground transition-colors flex-shrink-0"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"
                  />
                </svg>
                <span class="font-medium text-sm truncate">{category.name}</span>
              </div>
              <span class="inline-flex items-center justify-center px-2 py-0.5 rounded-full text-xs font-medium bg-secondary text-secondary-foreground group-hover:bg-primary group-hover:text-primary-foreground transition-colors flex-shrink-0 ml-2">
                {category.count}
              </span>
            </a>
          ))
        }
      </div>
    </section>
    
    <section class="mt-4 grid grid-cols-1 lg:grid-cols-4 gap-6 my-4">
      
      <LiquidGlass
        heavy
        containerClass="lg:col-span-3"
      >
        
        <section class="rounded-lg">
          <div class="p-3">
            <div class="mb-2">
              <h2
                class="text-2xl font-bold mb-2 text-txt-p dark:text-darkmode-txt-p"
              >
                最新文章
              </h2>
            </div>

            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              {
                featuredPosts.map((post: any, index: number) => (
                  <div class="transform hover:scale-105 transition-transform duration-300 intersect:animate-fadeUp">
                    <BlogCard entry={post} />
                  </div>
                ))
              }
            </div>

            
            <div class="text-center">
              <Button
                label="查看所有文章"
                link="/blog"
                newtab={false}
                hoverInvert
                color=""
              />
            </div>
          </div>
        </section>
      </LiquidGlass>

      
      <div class="flex flex-col lg:col-span-1 space-y-6">
        
        <LiquidGlass heavy >
          <section class="rounded-lg pt-3">
            <div class="flex items-center justify-between mb-4 px-3">
              <h3 class="text-xl font-bold text-txt-p dark:text-darkmode-txt-p">
                推荐阅读
              </h3>
            </div>

            <div class="space-y-2 px-2 md:px-0">
              {
                recommendedPosts.slice(0, 4).map((post: any, index: number) => (
                  <div
                    class="transform hover:scale-105 transition-transform duration-300 intersect:animate-fadeUp"
                    style={`animation-delay: ${index * 200}ms`}
                  >
                    <RecommendedReadCardComponent
                      entry={post}
                      showImage={true}
                      showReadingTime={true}
                      compact={false}
                    />
                  </div>
                ))
              }
            </div>
          </section>
        </LiquidGlass>

        

        
        <LiquidGlass heavy >
          <HomeNotesPreview entries={latestNotes} limit={5} />
        </LiquidGlass>

        
      </div>
    </section>
  </div>
</BaseLayout>

<style>
  @keyframes blink {
    0%,
    50% {
      opacity: 1;
    }
    51%,
    100% {
      opacity: 0;
    }
  }

  .typewriter-cursor::after {
    content: "|";
    animation: blink 1.2s infinite;
    color: #f97316;
  }
</style>

<script></script>
